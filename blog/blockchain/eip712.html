<!DOCTYPE html>
<html lang="en">
    <head>
    <!-- meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>EIP-712: Typed Structured Data.</title>
    <meta name="description" content="This is the second article illustrating hashing and signing typed structured data, the first article discussed key generation and message.">
    <meta name="keywords" content="eip-712, structured-data, ethsign, blockchain, ethereum">
    <meta name="author" content="Sasha Flores">
    <meta property="og:type" content="website">

    <!-- Bootstrap CSS -->
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/aos.css" rel="stylesheet">
    <link href="../../css/navbar.css" rel="stylesheet">
    <link href="../../css/new-common-articles.css" rel="stylesheet">
    <link href="../../css/blog/blockchain/eip712.css" rel="stylesheet">
    <link href="../../css/footer.css" rel="stylesheet">





    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MXTX916K7T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-MXTX916K7T');
    </script>
</head>


<body class="page-offset">
    <i class="bi bi-list mobile-nav-toggle d-xl-none"></i>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
            <div class="container-fluid px-md-5">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0" data-aos="fade-down" data-aos-duration="1000">
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="../../index.html">HOME</a>
                        </li>

                        <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="aboutDropdown"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">ABOUT ME</a>
                            <ul class="dropdown-menu" aria-labelledby="aboutDropdown">
                                <li><a class="dropdown-item" href="../../background.html">Background</a></li>
                                <li><a class="dropdown-item" href="../../skills.html">Skills</a></li>
                                <li><a class="dropdown-item" href="../../experience.html">Experience</a></li>
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="../../portfolio.html">PORTFOLIO</a></li>
                        <li class="nav-item"> <a class="nav-link active" href="../../blog.html">BLOG</a></li>
                        <li class="nav-item"><a class="nav-link" href="../../contact.html">CONTACT</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="article-container">
        <h1 id="title">EIP-712: Typed Structured Data.</h1>
        <figure class="meta">
            <img alt="" src="https://miro.medium.com/1*EpKtUG4ZQaEIvI1o486a2w.gif" />
        </figure>

        <div class="article-stats" data-post-id="eip-712">
            <button type="button" class="stat" data-role="like">
                <ion-icon name="thumbs-up-outline"></ion-icon>
                <span class="stat-number">0</span>
            </button>
            <div class="stat stat-view">
                <ion-icon name="eye-outline"></ion-icon>
                <span class="stat-number">0</span>
            </div>
        </div>

        <p>
            <i>This is the second article illustrating hashing and signing typed structured data,
                <a
                    href="https://www.sashaflores.xyz/blog/blockchain/public-private-keys-generation-and-signature-verification.html">the
                    first article</a> discussed key generation and message hashing and signing..
            </i>
        </p>
        <h2 class="title t-2">EIP-712 is a standard for secure off-chain signature verification.</h2>
        <p>
            It is the procedure for hashing and signing typed structured data as opposed to strings,
            it encodes function data similar to & compatible with solidity structs, and it depends on two other EIPs:
        </p>
        <h2 class="title t-2"><a href="https://eips.ethereum.org/EIPS/eip-191">EIP191</a>:</h2>
        <p>
            <code>0x01</code> which was briefly mentioned in the previous article. Unlike the two
            other versions, this structured data version doesn't start with <code>0x19</code> because it is indeed a
            RLP-structure, but it is still in-compliant with EIP-191 by including the ‘version byte` fixed to <code>0x01</code>
        </p>
        <img alt="first article -purpose of `0x19`" src="https://miro.medium.com/1*3ofsjZEH52oOGpgT_-6_yg.png" />
        <h2 class="title t-2"><a href="https://eips.ethereum.org/EIPS/eip-155">EIP155</a>:</h2>
        <p>
            introduce chain Id as one of the encoded transaction parameters so instead of hashing only six RLP 
            encoded transaction parameters we should hash nine, as shown below:
        </p>
        <ul>
            <li>chain Id is used to calculate v value.</li>
            <li>
                the proposal still supports both signature scheme so it's up to the developer to use the old signature scheme where 
                v = 27 and v = 28 or the updated signature scheme where chain Id is part of v value.
            </li>
        </ul>
        <script src="https://gist.github.com/SashaFlores/2585b879942977f2589f17db4a2fd55b.js"></script>
        <p>
            If block.number ≥ FORK_BLKNUM & Chain Id is available, then computing the transaction hash should hash nine RLP encoded parameters. 
            If you do, then the v of the signature MUST include chain Id as shown in table.
        </p>
        <h2 class="title t-2"><a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a>:</h2>
        <p>
            This proposal aims to improve the usability of off-chain message 
            signing for use on-chain. We are seeing growing adoption of off-chain message signing as it saves 
            gas and reduces the number of transactions on the blockchain.
        </p>
        <h3 class="title t-3">Q: What is the acceptable typed structured data?</h3>
        <p>
            It accepts data like it does with struct in solidity where the struct has a name as an identifier that contains zero or several
            member variables; each member variable has a type and a name. The type can be either an atomic type, a dynamic type, or a reference 
            type as shown in table below:
        </p>
        <script src="https://gist.github.com/SashaFlores/cd97bc47b6bad106ddcf689bcde4d22a.js"></script>
        <p>
            Basically we're defining the struct that will be used in any transaction & specify their types, 
            let's take <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/ERC20Permit.sol">ERC20Permit </a>
            as an example & walk through how the data is structured:
        </p>
        <div class="codebox">
            <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                <ion-icon name="copy-outline"></ion-icon>
            </button>
        
            <pre><code id="code-install">
                /**
                * `Permit` is the struct identifier name.
                * - `address` is the atomic type of named `owner`.
                * - `uint256` is the atomic type of named `spender`.
                * - `uint256` is the atomic type of named `value`.
                * - `uint256` is the atomic type of the randomly 
                *    generated value during the signing process named `nonce`.
                * - `uint256` is the atomic type of named `deadline`
                */
                struct Permit {
                    address owner;
                    address spender;
                    uint256 value;
                    uint256 nonce;
                    uint256 deadline;
                }
            </code></pre>
        </div>
        <p>
            So the identifier name of the struct, type of each element and its value are what the proposal use to build 
            its components which are:
        </p>

        <h4 class="title t-4">Hash Struct</h4>
        <ul>
            <li>from it's name; it is hashing the struct.</li>
            <li>hashing the struct consists of hashing two components:<br>
                 <code>hashStruct = keccak256(typeHash ‖ encodeData(s))</code></li>
        </ul>
        
        <div class="subsection">
            <h5 class="subtitle s-5">1. typeHash:</h5>
            <ul>
                <li>
                    is the process of hashing the encoded type of struct where each member is written as type & name.
                </li>
                <li>
                    is a constant for a given struct type & doesn’t need to be runtime computed:</br>
                    <code>typeHash = keccak256(encodeType(typeOf(s)))</code>
                </li>
            </ul>
            <div class="codebox">
                <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                    <ion-icon name="copy-outline"></ion-icon>
                </button>
            
                <pre><code id="code-install">
                    /**
                    * Hashing the struct name, where each memeber has a type & name in 
                    * a constant variable `_PERMIT_TYPEHASH` which is fixed at compile-time
                    * - `Permit` struct identifier name.
                    * - `address` is the type of `owner` name.
                    * - `address` is the type of `spender` name.
                    * - `uint256` is the type of `value` name.
                    * - `uint256` is the type of `nonce` name.
                    * - `uint256` is the type of `deadline` name.
                    */
                    bytes32 private constant _PERMIT_TYPEHASH = keccak256("Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)")
                </code></pre>
            </div>
            <h5 class="subtitle s-5">2. encodeData:</h5>
            <ul>
                <li>is the process of encoding the struct instance.</li>
                <li>it concatenates all encoded member values in the order they appear in the type, where each member value is 32 bytes long.</li>
            </ul>

            <div class="codebox">
            <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                <ion-icon name="copy-outline"></ion-icon>
            </button>
        
            <pre><code id="code-install">
                // `permit` function which instantiate `Permit` struct.
                function permit(
                    address owner,
                    address spender,
                    uint256 value,
                    uint256 deadline,
                    uint8 v,
                    bytes32 r,
                    bytes32 s
                ) public virtual override {
                    require(block.timestamp <= deadline, "ERC20Permit: expired deadline");
                    /**
                    * encode the type of struct Hash `_PERMIT_TYPEHASH'
                    * enode the struct instance in the order they appear as follows:
                    * - `owner`, `spender`, `value`, `nonce`, & `deadline`
                    * finally hash the set of structurced typed data containing all 
                    * the instances of all the strcut types 
                    */
                    bytes32 structHash = keccak256(abi.encode(_PERMIT_TYPEHASH, owner, spender, value, _useNonce(owner), deadline));

                
                    bytes32 hash = _hashTypedDataV4(structHash);

                    address signer = ECDSA.recover(hash, v, r, s);
                    require(signer == owner, "ERC20Permit: invalid signature");

                    _approve(owner, spender, value);
                }
            </code></pre>
        </div>
        <h3 class="title t-3">Q: How different types are encoded in the EVM?</h3>
        <script src="https://gist.github.com/SashaFlores/fd7619c744ad28f678e0b80c7eee8494.js"></script>
        </div>
        <h4 class="title t-4">Domain Separator</h4>
        <code>domainSperator = hashStruct(eip712Domain)</code>
        <ul>
            <li>
                is the process of hashing domain information to be used as a domain separator.
            </li>
            <li>
                it’s designed to separate between two different domains that may have identical data structure to avoid validating same signatures for both.
            </li>
            <li>
                where the type of eip712Domain is a struct named EIP712Domain.
            </li>
            <li>
                by default in OZ, all fields below are included but developers can include or skip only the fields that make sense for their signing domain.
            </li>
            <li>
                It’s important to preserve the order as shown below, skipping any absent fields if any.
            </li>
        </ul>
        <div class="codebox">
            <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                <ion-icon name="copy-outline"></ion-icon>
            </button>
        
            <pre><code id="code-install">
                struct EIP712Domain {
                    string name;    // name of the DApp 
                    string version; // current version of the signing domain
                    uint256 chainId; // EIP-155 chain id
                    address verifyingContract;  // address of contract verifying signature
                    bytes32 salt;   // domain separtor
                }
            </code></pre>
            
        </div>

        <p>
            This is already build and coded in 
            <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/EIP712.sol">EIP712.sol
            </a>
            from OZ so if you are inheriting the contract you don't need to do anything, but to follow the example:
        </p>

        <div class="subsection">
            <h5 class="subtitle s-5">
                1. we will hash all type values in struct and make it constant to be computed at compile-time as follows:
            </h5>
            <div class="codebox">
            <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                <ion-icon name="copy-outline"></ion-icon>
            </button>
        
            <pre><code id="code-install">
                bytes32 private constant _TYPE_HASH = keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)")
            </code></pre>
        </div>
        <p><strong>Note: be careful with the order of the types to be exactly the same as struct & no spaces after each comma.</strong></p>

        <h5 class="subtitle s-5">
            2. In your contract constructor you will input your DApp or Protocol name and version, but under the hood the following is happening:
        </h5>
        <ul>
            <li>
                the name will be hashed: <code>keccak256(bytes(name))</code>
            </li>
            <li>
                the version will be hashed: <code>keccak256(bytes(version))</code>
            </li>
            <li>
                and the domain separator will be equal to:<br>
                <code>function domainSeparator() public view returns(bytes32) {return keccak256(abi.encode(_TYPE_HASH, hashedName, hashedVersion, block.chainid, address(this)))}</code>
            </li>
        </ul>
        <p><strong>Customize Signing Domain Example:</strong></p>
        <p>
            In case you want to customize the EIP-712 and code it yourself, as an example we will have the name of the protocol
            as a constant since it will not change during it’s life time:
        </p>

        <div class="codebox">
            <button class="copy-btn" data-copy-target="#code-install" aria-label="Copy code">
                <ion-icon name="copy-outline"></ion-icon>
            </button>
        
            <pre><code id="code-install">
                // optional 
                string public constant NAME = 'dapp name';

                bytes32 private constant DOMAIN_SEPARATOR_TYPEHASH = keccak256(EIP712Domain(string version,uint256 chainId,address verifyingContract));


                /**
                * domainSeparator = hashStruct(eip712Domain).
                * - `DOMAIN_SEPARATOR_TYPEHASH`: keccack256 hashing `typeHash`
                * - `keccak256(bytes(version))`: Dynamic data type hashing of string
                * - `block.chainid` & `address(this)`: Atomic data type hashing of uint256 & address.
                */
                function domainSeparator() public view returns(bytes32) {
                    return keccak256(abi.encode(DOMAIN_SEPARATOR_TYPEHASH, keccak256(bytes(version)), block.chainid, address(this)))
                }
            </code></pre>
        </div>
        <p><strong>Signing Typed Structured Data</strong></p>
        <p><code>eth_signTypedData</code> is similar to <code>eth_sign</code> method with 2 parameters:</p>
        <ul>
            <li>Address of the account signing transaction.</li>
            <li>Typed structured data to sign.</li>
            
        </ul>
        <p>
            Typed data is a JSON object that contains type information, domain separator, and the message object
            which will be displayed to signer as:
        </p>
        <img alt="" src="https://miro.medium.com/1*Dw0MU2IC9ZgjsJ2EoWs8PQ.png" />
        <p>
            which will returns a 65 bytes signature as in <code>eth_sign</code> with the same parameters of r & s each equals
            32 bytes and v of 1 byte that includes the chain id.
        </p>
        <p>
            If the signing address is an Externally Owned Account (EOA) then <code>ecrecover</code>is used to verify that the
            public key matches
            the key that generates the signature. Further restrictions can be specified like the signer is the owner of the
            contract as in ERC20Permit.
        </p>
        <p>
            That will lead us to the next article that will answer the question, what if the signing account isn't an EOA but
            another smart contract.
        </p>
        
        </div>

    </div>


    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Sasha Flores. All Rights Reserved.</p>
            <div class="social-links">
                <a href="https://www.linkedin.com/in/sflores369/" target="_blank"><ion-icon
                        name="logo-linkedin"></ion-icon></a>
                <a href="https://discord.com/users/827160247428710422" target="_blank"><ion-icon
                        name="logo-discord"></ion-icon></a>
                <a href="https://github.com/SashaFlores" target="_blank"><ion-icon name="logo-github"></ion-icon></a>
                <a href="https://www.youtube.com/@web3securityengineer" target="_blank"><ion-icon name="videocam-sharp"></ion-icon><span class="tooltip"></span></a>
            </div>
        </div>
    </footer>
    
    
    
    <script src="../../js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../js/aos.js"></script>
    <script src="../../js/custom.js"></script>
    <script src="../../js//code-copy.js"> </script>
    
    <script type="module" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.js"></script>

   

</body>
</html>